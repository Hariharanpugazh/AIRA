# =============================================================================
# LiveKit Admin Platform - Production Docker Compose
# Ultra-low latency (<100ms) | Single config for local + production
# =============================================================================
# Usage:
#   docker compose up -d              # Start all services
#   docker compose --profile gpu up -d # With GPU AI services
#   docker compose logs -f            # Watch logs
# =============================================================================

services:
  # ===========================================================================
  # NGINX - Reverse Proxy
  # ===========================================================================
  nginx:
    image: nginx:alpine
    container_name: lk-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      frontend:
        condition: service_started
      backend:
        condition: service_healthy
    networks:
      - lk-net
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ===========================================================================
  # FRONTEND - Next.js
  # ===========================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: lk-frontend
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=/api
    networks:
      - lk-net

  # ===========================================================================
  # BACKEND - FastAPI (Optimized for <100ms)
  # ===========================================================================
  backend:
    build:
      context: ./backend/api
      dockerfile: Dockerfile
    container_name: lk-backend
    restart: unless-stopped
    env_file: .env
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - lk-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s

  # ===========================================================================
  # POSTGRESQL
  # ===========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: lk-postgres
    restart: unless-stopped
    env_file: .env
    ports:
      - "5433:5432"
    volumes:
      - pg-data:/var/lib/postgresql/data
      - ./backend/api/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - lk-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ===========================================================================
  # REDIS - Caching for <100ms latency
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: lk-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --save 60 1 --loglevel warning
    volumes:
      - redis-data:/data
    networks:
      - lk-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3

  # ===========================================================================
  # LIVEKIT SERVER
  # ===========================================================================
  livekit:
    image: livekit/livekit-server:latest
    container_name: lk-server
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "7880:7880"
      - "7881:7881"
      - "7882:7882/udp"
    command: --config /etc/livekit.yaml --bind 0.0.0.0
    volumes:
      - ./backend/docker/livekit.yaml:/etc/livekit.yaml:ro
    networks:
      - lk-net
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:7880/"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ===========================================================================
  # INGRESS
  # ===========================================================================
  ingress:
    image: livekit/ingress:latest
    container_name: lk-ingress
    restart: unless-stopped
    depends_on:
      livekit:
        condition: service_healthy
    ports:
      - "1935:1935"
      - "8090:8080"
    volumes:
      - ./backend/docker/ingress.yaml:/etc/ingress.yaml:ro
    environment:
      - INGRESS_CONFIG_FILE=/etc/ingress.yaml
    networks:
      - lk-net

  # ===========================================================================
  # EGRESS
  # ===========================================================================
  egress:
    image: livekit/egress:latest
    container_name: lk-egress
    restart: unless-stopped
    depends_on:
      livekit:
        condition: service_healthy
    volumes:
      - ./backend/docker/egress.yaml:/etc/egress.yaml:ro
      - egress-out:/out
    environment:
      - EGRESS_CONFIG_FILE=/etc/egress.yaml
    networks:
      - lk-net
    cap_add:
      - SYS_ADMIN

  # ===========================================================================
  # AI: Whisper STT (GPU)
  # ===========================================================================
  whisper:
    image: fedirz/faster-whisper-server:latest-cuda
    container_name: lk-whisper
    profiles: ["gpu"]
    restart: unless-stopped
    ports:
      - "8001:8000"
    environment:
      - WHISPER__MODEL=Systran/faster-whisper-large-v3-turbo
      - WHISPER__DEVICE=cuda
    volumes:
      - whisper-cache:/root/.cache
    networks:
      - lk-net
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # ===========================================================================
  # AI: Kokoro TTS (GPU)
  # ===========================================================================
  kokoro:
    image: ghcr.io/remsky/kokoro-fastapi-gpu:latest
    container_name: lk-kokoro
    profiles: ["gpu"]
    restart: unless-stopped
    ports:
      - "8880:8880"
    networks:
      - lk-net
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # ===========================================================================
  # AI: Ollama LLM
  # ===========================================================================
  ollama:
    image: ollama/ollama:latest
    container_name: lk-ollama
    profiles: ["gpu"]
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama-models:/root/.ollama
    networks:
      - lk-net

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  pg-data:
  redis-data:
  egress-out:
  whisper-cache:
  ollama-models:

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  lk-net:
    driver: bridge
